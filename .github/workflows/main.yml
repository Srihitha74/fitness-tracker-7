name: "CI Pipeline: Build Full Stack and Push to Docker Hub"

on:
push:
branches:
- master # Using 'master' branch

jobs:
build-and-push:
runs-on: ubuntu-latest

steps:
  - name: Checkout Code
    uses: actions/checkout@v4

  # 1. BUILD THE SPRING BOOT BACKEND
  - name: Set up Java and Maven
    uses: actions/setup-java@v4
    with:
      java-version: '17'
      distribution: 'temurin'
      cache: 'maven' 
      
  - name: Build Backend JAR with Maven
    run: |
      cd fitness-tracker-backend 
      ./mvnw clean package -DskipTests 
      
  # 2. BUILD THE REACT FRONTEND
  - name: Set up Node.js
    uses: actions/setup-node@v4
    with:
      node-version: '18'
      cache: 'npm'

  - name: Install and Build Frontend
    run: |
      cd fitness-tracker-frontend 
      npm install
      npm run build

  # 3. DOCKER LOGIN AND PUSH
  - name: Log in to Docker Hub
    uses: docker/login-action@v3
    with:
      username: ${{ secrets.DOCKER_USERNAME }}
      password: ${{ secrets.DOCKER_PASSWORD }}
      
  - name: Build and Push Backend Image
    uses: docker/build-push-action@v5
    with:
      context: ./fitness-tracker-backend 
      file: ./fitness-tracker-backend/Dockerfile
      push: true
      tags: ${{ secrets.DOCKER_USERNAME }}/fitness-tracker-backend:latest
      
  - name: Build and Push Frontend Image
    uses: docker/build-push-action@v5
    with:
      context: ./fitness-tracker-frontend 
      file: ./fitness-tracker-frontend/Dockerfile
      push: true
      tags: ${{ secrets.DOCKER_USERNAME }}/fitness-tracker-frontend:latest